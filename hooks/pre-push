#!/bin/bash

# Git pre-push hook to run unit tests before pushing to remote
# This ensures code quality and prevents broken code from being pushed
#
# This hook is automatically used via git config core.hooksPath

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Note: This hook runs from hooks/ directory (via core.hooksPath config)
# No installation needed - Git automatically uses hooks from this directory

echo -e "${YELLOW}üîç Pre-push hook: Running unit tests...${NC}"
echo ""

# Check if Go is installed
if ! command -v go &> /dev/null; then
    echo -e "${RED}‚ùå Error: Go is not installed!${NC}"
    echo "Please install Go 1.21 or later: https://go.dev/dl/"
    exit 1
fi

# Get the repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"

if [ -z "$REPO_ROOT" ]; then
    # Fallback: assume we're in hooks/ directory, go up one level
    REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
fi

cd "$REPO_ROOT"

# Check if we're in the lib repo
if [ ! -f "go.mod" ] || [ ! -f "scripts/run_tests.sh" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Not in lib repo, skipping tests${NC}"
    exit 0
fi

# Run the unit tests
echo -e "${GREEN}Running unit tests...${NC}"
echo ""

if ./scripts/run_tests.sh; then
    echo ""
    echo -e "${GREEN}‚úÖ All tests passed! Proceeding with push...${NC}"
    exit 0
else
    echo ""
    echo -e "${RED}‚ùå Tests failed! Push aborted.${NC}"
    echo ""
    echo "Please fix the failing tests before pushing."
    echo "To bypass this check (not recommended), use:"
    echo "  git push --no-verify"
    exit 1
fi
